---
title: "Chap5_7"
author: "J.H AHN"
date: '2021 12 8 '
output:
  word_document: default
  html_document: default
---


```{r setup, include=FALSE}
library(fpp3)

knitr::opts_chunk$set(echo = TRUE)
```

## 5.7 Forecasting with decomposition

시계열 분해(decomposition)은 예측을 수행하는데 유용하다.  
추가적인 분해요소를 가정하면 분해된 시계열을 아래와 같이 표현할 수 있다.  

$$y_t = \hat{S}_t + \hat{A}_t$$

$\hat{A}_t = \hat{T}_t+\hat{R}_{t}$는 계절성이 adjust된 요소이고 만약 승수형태의 분해요소(multiplicative decomposition)라면 아래와 같이 쓸 수 있다.  

$$y_t = \hat{S}_t\hat{A}_t$$

이 경우에 $\hat{A}_t = \hat{T}_t\hat{R}_{t}$가 된다.  





분해한 시계열을 예측하기 위해서는 계절성$\hat{S}_t$(seasonal component)과 계절성이 adjust된 $\hat{A}_t$를 나눠서 예측해야 한다.  
보통 계절성은 변하지 않거나 매우 느리게 변화하기 때문에 지난 해 정보를 이용하면 간단하게 예측이 된다.  
그래서 계절성을 예측하는데는 Seasonal naive method를 사용한다.  

Seasonally adjust component나 계절성이 없는 요소를 예측하기 위해서는 (drift가 적용된) random walk method를 사용한다.  
예를 들어 drift method나 Holt's method, non-seasonal ARIMA model을 사용한다.  

### Example: Employment in the US retail sector

```{r}
head(us_employment)

```



```{r}
us_retail_employment <- 
    us_employment %>% 
    filter(year(Month) >= 1990, Title == "Retail Trade")


us_retail_employment
```


```{r}
dcmp <- 
    us_retail_employment %>% 
    model(STL(Employed ~ trend(window = 7), robust = TRUE)) %>% 
    components() %>% 
    select(-.model)


dcmp

```

```{r}
dcmp %>% 
    model(NAIVE(season_adjust)) %>% 
    forecast() %>% 
    autoplot(dcmp) + 
    labs(y = "Number of people",
         title = "US retail employment")


```


위 plot은 naive method로 US retail employment data의 season_adjust열의 값을 예측한 것이다.    
계절성을 가진 요소에 계절성을 naive method로 예측한 결과를 더해 "재계절화(re-seasonalised)"하였다.    

이것은 각각의 분해요소를 다른 모델 함수를 사용하여 예측한 것을 additive decomposition으로 계산해주는   `decomposition_model()`함수를 쓰면 쉽게 구현할 수 있다.  
특별히 다른 모델을 사용하라는 입력이 없다면 계절성은 `SNAIVE()`함수를 사용하여 자동으로 예측된다.  
이 함수는 원래 데이터의 결과 예측값을 얻을 수 있도록 re-seasonalising을 해준다.   


```{r}
fit_dcmp <- 
    us_retail_employment %>% 
    model(stlf = decomposition_model(
        STL(Employed ~ trend(window = 7), robust = TRUE),
        NAIVE(season_adjust)
    ))

fit_dcmp


```


```{r}
fit_dcmp %>% 
    forecast() %>% 
    autoplot(us_retail_employment) +
    labs(y = "Number of people",
         title = "US retail employment")

```

plot에 표시된 prediction intervals은 포인트 예측과 동일한 방법으로 이뤄진다.  
즉 seasonally adjusted data의 prediction intervals 상/하한값은 계절성의 예측값을 더해 re-seasonalising된다.  

아래 plot은 잔차의 ACF결과로 자기상관성이 나타남을 알 수 있다.  
이는 seasonally adjusted data가 변하는 추세를 naive method가 완전하게 잡아내지 못하고 있기 때문이다.  

```{r, warning=FALSE}
fit_dcmp %>% 
    gg_tsresiduals()


```


이러한 잔차의 자기상관성을 제거할 수 있는 더 적합한 방법이 필요하다.  
naive method로는 seasonally adjusted data를 처리하는데 한계가 있다.  



























