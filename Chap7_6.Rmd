---
title: "Chap7_6"
author: "J.H AHN"
date: '2021 12 16 '
output: html_document
---

```{r setup, include=FALSE}
library(fpp3)

knitr::opts_chunk$set(echo = TRUE)
```

## 7.6 Forecasting with regression

$y$의 예측은 아래 식을 사용하여 얻을 수 있다는 것을 상기해보자.  


$$\hat{y_t} = \hat\beta_{0} + \hat\beta_{1} x_{1,t} + \hat\beta_{2} x_{2,t} + \cdots + \hat\beta_{k} x_{k,t},$$


이 식은 추정된 계수($\beta$)를 포함하고 회귀 방정식의 error를 무시한다.  


$t=1,\dots,T$에 해당하는 예측변수 $x_{1,t},\dots,x_{k,t}$를 대입시키면 $y$의 fitted value(training set)를 얻을 수 있다.  


여기서 흥미로운 부분은 미래값 $y$는 어떻게 예측할 수 있는가이다.  




### Ex-ante versus ex-post forecasts


시계열 데이터에 회귀 모델을 사용할 때는 예측을 계산할 때 알려진 것으로 가정한 것에 따라 생성할 수 있는 다양한 예측 유형을 구별해야 한다.  


**사전예측(Ex-ante forecasts)**은 사전에 입수할 수 있는 정보만을 사용하여 만들어진 예측이다.  
분석 당시에 가용한 정보만을 사용해야 한다.  예를 들어 us_change 데이터 셋을 이용하려면 데이터 셋에 포함된 2019년 2분기까지의 데이터만 사용해야 한다.  


```{r}
max(us_change$Quarter)

```


이것들은 분석 당시에 이용 가능한 모든 정보를 이용하여 만들어진 진짜 예측이다.  
따라서 사전 예측을 생성하려면 모델에 predictor의 예측값이 필요하다.  


이를 얻기 위해서는 Chap5_2에서 소개된 간단한 방법 중 하나나 Chap 8 또는 Chap 9에서 다룰 정교한 시계열 접근법을 사용할 수 있다. 대안으로 다른 출처의 예측 데이터를 사용할 수 있다.   



**사후예측(Ex-post forecasts)**은 예측변수에 대한 이후의 정보를 사용하여 만든 것이다.  
예를 들어 소비에 대한 사후 예측은 예측변수가 관찰되면 실제로 관찰할 수 있다.  
이는 진정한 의미의 예측이라 할 수 없지만 예측 모델이 어떻게 움직이는지 연구하는데 유용하다.  


사후 예측으로부터 만들어진 모델은 예측기간의 데이터를 사용하여 추정해서는 안된다. 즉 사후 예측은 predictor variable(x variable)은 알고 있다고 가정할 수 잇으나 forecast(y variable)에 대해서는 알고 있다고 가정해서는 안된다.  


사전 예측과 사후 예측의 비교 평가는 예측 불확실성의 원인을 분리하는데 도움이 될 수 있다.  
이것은 predictor가 나빠서 예측 오차가 발생했는지, 예측모델(forecasting model)이 나빠서 예측 오차가 발생했는지를 알려준다.  





### Example: Australian quarterly beer production

일반적으로 사전 예측을 생성할 때 predictor의 실제 미래 값은 미리 알 수 없기 때문에 사용할 수 없다.  그러나 Chap7_4에 소개된 특수한 예측변수는 달력 변수(예. 계절성 더비변수 혹은 공휴일 지표)또는 시간의 결정론적 함수(예. 시간 추세)를 기반으로 하기 때문에 모두 미리 알려져 있다.  
이런 경우 사전 예측과 사후 예측간의 차이는 없다.  


```{r}
recent_production <- 
    aus_production %>% 
    filter(year(Quarter) >= 1992)

fit_beer <- recent_production %>% 
    model(TSLM(Beer ~ trend() + season()))

fc_beer <- forecast(fit_beer)

fc_beer %>% 
    autoplot(recent_production) +
    labs(title = "Fig 7.17-Forecasts of beer production using regression",
         y = "megaliters")



```



### Scenario based forecasting

예측하는 사람이 관심이 있는 predictor에 대해 가능한 시나리오를 가정한다.  
예를 들어 정책 입안자라면 데이터 취득 이후 4분기 동안 고용률의 변화 없이 소득과 저축이 각각 1%, 0.5%씩 지속적으로 성장하는 경우와 1%, 0.5%씩 감소하는 경우를 비교하는데 관심이 있을 수 있다.  


결과 예측은 아래에 있고, Fig 7.18에 보여진다.  
시나리오 기반 prediction interval에는 predictor의 미래값에 관련된 불확실성이 포함되지 않았다는 것을 알아둬야 한다.  
그들은 predictor의 값을 사전에 알고 있었다고 가정한다.  

```{r}
fit_consBest <- us_change %>%
    model(
        lm = TSLM(Consumption ~ Income + Savings + Unemployment)
    )
future_scenarios <- scenarios(
    Increase = new_data(us_change, 4) %>%
        mutate(Income=1, Savings=0.5, Unemployment=0),
    Decrease = new_data(us_change, 4) %>%
        mutate(Income=-1, Savings=-0.5, Unemployment=0),
    names_to = "Scenario")

fc <- forecast(fit_consBest, new_data = future_scenarios)


```


```{r}
us_change %>%
    autoplot(Consumption) +
    autolayer(fc) +
    labs(title = "Figure 7.18-US consumption", y = "% change")


```



### Building a predictive regression model

회귀모델의 가장 큰 장점은 관심있는 forecast variable과 predictor variable간의 관계를 찾아낼 수 있다는 것이다.  
그러나 사전 예측(ex ante forecasts)의 경우, 이러한 모델들은 각 predictor의 미래값들을 요구하기 때문에 어려울 수 있다.  
만약 각 predictor를 예측하는게 너무 어렵다면, 모든 predictor에 대한 미래값이 정해진 것으로 가정한 시나리오 기반 예측을 사용해 볼 수도 있다. 


대안으로 predictor의 지연값을 사용하는 식을 사용할 수도 있다.  
$h=1,2\dots$에 대한 $h$-step 앞의 예측은 아래의 식으로 표현된다.  


$$y_{t+h}=\beta_0+\beta_1x_{1,t}+\dots+\beta_kx_{k,t}+\varepsilon_{t+h}$$


predictor set은 $y$값을 관측하기 전 $h$시간 동안 관측된 $x_s$에 의해 만들어진다.  
따라서 추정된 모델이 미래, 즉 sample $T$의 끝을 넘어서 투영될 때 모든 predictor values를 사용할 수 있다.  


predictor의 지연값을 포함하면 예측을 쉽게 생성할 수 있도록 모델을 작동시킬 수 있을 뿐 아니라 직관적으로 만들수 있다.  
예를 들어 생산 증가를 목표로 한 정책 변경의 효과는 즉각적인 영향을 미치지 않을 수 있다.  
이것은 지연 효과로 얼마 후에 발생할 가능성이 높다.  
예측 변수로 분산된 지연(distributed lags)을 간단히 소개할 때 Chap7_4에서 설명했었다.  
시계열에서 관찰된 풍부한 역학관계를 더 잘 통합하기 위해 회귀모델을 일반화하는 몇가지 방향은 Chap 10에서 논의된다.  




### Prediction intervals

Fig 7.18의 소비 변화에 대한 각 예측은 95%와 80%의 prediction interval도 포함된다.  
다중회귀모델에 대한 prediction interval을 계산하는 방법에 대한 일반적인 공식은 Chap7_9에 나와 있다.  

여기에는 일부 advanced matrix algebra가 포함되므로 방전식을 사용하여 예측을 생성할 수 있는 단순 회귀에 대한 prediction interval을 계산하는 경우를 제시한다.  


$$\hat{y}=\hat{\beta}_0+\hat{\beta}_1x.$$


regression errors가 정규분포를 따른다고 가정하면 이 예측과 관련된 대략적인 95% prediction interval은 아래와 같이 주어진다.  


$$\begin{equation}
  \hat{y} \pm 1.96 \hat{\sigma}_e\sqrt{1+\frac{1}{T}+\frac{(x-\bar{x})^2}{(T-1)s_x^2}},
  \tag{7.4}
\end{equation}$$


$T$는 관측치의 수, $\bar{x}$는 관찰된 $x$값의 평균, $s_x$는 관찰된 $x$값의 표준편차, $\hat{\sigma}_e$는 식(7.3)에 의해 주어진 회귀의 표준 오차(standard error)이다.  


유사하게 1.96을 1.28로 대체하여 80% prediction interval을 구할 수 있다.  
다른 예측 구간은 1.96 대신 적절한 값을 표(5.1)에서 찾아 대체하면 얻을 수 있다.  


`fable`package를 사용하여 prediction interval을 구하면 더 정확한 계산이 가능하다.  
(특히 작은 $T$값의 경우)


식(7.4)는 $x$가 $\bar{x}$에서 멀 때 prediction interval이 더 넓어짐을 보여준다.  
즉 표본 평균에 가까운 예측 변수 값을 고려할 때 예측이 더 정확하다.  




#### Example


US consumption 예시에서 찾은 estimated simple regression line은 아래와 같다.


```{r}
fit_cons <- 
    us_change %>% 
    model(TSLM(Consumption ~ Income))

report(fit_cons)

```


$$\hat{y}_t=0.54 + 0.27x_t.$$


다음 4개 분기를 가정해보자.  


personal income은 역사적인 평균값($\bar{x}=0.73%$)만큼 증가되고, consumption은 0.74% 증가될 것으로 예상된다.  
그에 따른 80%, 95% prediction interval은 $[-0.02, 1.5]$, $[-0.42, 1.9]$이다.  


만약 income이 극단적으로 12% 증가한다고 가정하면 prediction interval은 Fig 7.19에 보는 바와 같이 매우 넓어진다.  


'fabletools::scenarios()`

```{r}
new_cons <- 
    scenarios(
        "Average increase" = new_data(us_change, 4) %>%
            mutate(Income = mean(us_change$Income)),
        "Extreme increase" = new_data(us_change, 4) %>%
            mutate(Income = 12),
        names_to = "Scenario"
    )
new_cons

```

```{r}
fcast <- forecast(fit_cons, new_cons)

fcast

```


```{r}
us_change %>%
    autoplot(Consumption) +
    autolayer(fcast) +
    labs(title = "Fig 7.19-US consumption", y = "% change")

```








