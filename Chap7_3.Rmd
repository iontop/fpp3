---
title: "Chap7_3"
author: "J.H AHN"
date: '2021 12 16 '
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
library(fpp3)

knitr::opts_chunk$set(echo = TRUE)
```

## 7.3 Evaluating the regression model

관측값 $y$와 그에 대응하는 fitted $\hat{y}$차이를 training set errors 혹은 residuals라 하고, 아래와 같이 정의된다.  


$$\begin{align*}
  e_t &= y_t - \hat{y}_t \\
      &= y_t - \hat\beta_{0} - \hat\beta_{1} x_{1,t} - \hat\beta_{2} x_{2,t} - \cdots - \hat\beta_{k} x_{k,t}
\end{align*}$$


$t=1,\dots,T$에서 각 residual은 관측치로 예측할 수 없는 구성요소이다.  

residual에는 아래 두가지 외에 몇가지 유용한 속성이 있다.  


$$\sum_{t=1}^{T}{e_t}=0 \quad\text{and}\quad \sum_{t=1}^{T}{x_{k,t}e_t}=0\qquad\text{for all $k$}$$


이 특성으로 인해 residuals의 평균이 0이고 residual과 predictor variable에 대한 관측치 사이의 상관관계도 0 (= 상관관계가 없다)임을 알 수 있다. 단, 절편이 모델에서 생략된 경우에는 사실이 아닐 수 있다.  

회귀 변수를 선택하고 회귀 모델을 fitting한 후에는 모델의 가정의 충족되었는지 확인하기 위해 residual을 확인해봐야 한다. plotting을 해 보는 것이 가장 빠르고 쉽게 알 수 있는 방법이다.  
이 방법들은 아래에 차례로 논의된다.  




### ACF plot of residuals


시계열 데이터의 경우 현재 관측값이 이전 혹은 더 이전의 값과 유사할 가능성이 매우 높다.  
따라서 시계열 데이터의 회귀 모델을 다룰 때는 residual이 자기상관성(autocorrelation을 가지는지 확인해야 한다.  


추정된 모델의 residual이 자기상관성을 가지고 있다면 더 나은 예측모델을 만들기 위한 정보가 데이터에 남아 있다는 뜻이다. 자기상관 오류가 있는 모델은 편향(biased)되지 않아 틀렸다고 보기는 어렵지만 필요이상으로 큰 예측 간격을 가지고 있다.  
그러므로 항상 residual의 AcF plot을 그려서 확인해보아야 한다.  



### Histogram of residuals

residual이 정규분포를 가지는지 확인하는 것은 항상 옳다.  
앞서 설명한 것과 같이 이것은 예측에 필수적인 사항은 아니지만 prediction interval 계산을 훨씬 쉽게 만들어 준다.  


#### Example

Chap5_3에서 소개했던 `feasts::gg_tsresiduals()`함수를 사용하면 쉽게 residual 분석 결과를 얻을 수 있다.  

```{r}
fit_consMR <- 
    us_change %>% 
    model(tslm = TSLM(Consumption ~ Income + Production +
                          Unemployment + Savings))

```


```{r}
fit_consMR %>% 
    gg_tsresiduals() + 
    labs(title = "Fig 7.8-Analysing the residuals from a regression model for US quarterly consumption")

```


`fabletools::features()`함수는 argument로 입력된 feature function으로부터 구해진 dataset의 값을 요약하여 보여준다.  아래에서 features function은 residual이 독립적인지 확인하기 위해 Ljung-Box Test이고, 계산할 입력값은 innovation residual(.innov)이다.  


**Ljung-Box Test**는 결과값으로 산출되는 lb_stat값의 유의성이 중요한데 이를 검사하기 위해 p-value를 사용한다.  p-value가 0.05보다 작다면 우연히 lb_stat값이 나올 확룔이 미미하기 때문에 lb_stat값이 통계적으로 유의하나, 0.05보가 크면 우연히 발생할 확률이 있기 때문에 통계적으로 유의미하지 않다고 본다. 따라서 유의미하다면 (= p-value가 0.05보다 크다면) 해당 시계열의 residual은 백색잡음이라고 판단할 수 있다.  아래 예는 lb_pvalue < 0.05이므로 lb_stat이 유의성을 가지고 있다고 볼 수 있다.  

```{r}
augment(fit_consMR) %>% 
    features(.innov, ljung_box, lag = 10, dof = 5)

```


위의 time plot은 시간 경과에 따른 변화가 보이긴 하지만 특별한 점을 찾기 어렵다.  
이런 이분산성(heteroscedasticity)은 잠재적으로 prediction interval 범위를 부정확하게 만든다.  


**이분산성(heteroscedasticity)**은 범위에 따라 분산이 다르다는 의미이다.  
즉 회귀계수의 표준오차(분산)이 다르다는 의미로, 회귀계수의 유의성을 판단하려면 t-value(회귀계수를 표준오차로 나눈 값)를 구해야 하는데 이때 표준오차가 이분산성을 가지고 있으면 어느 표준오차값을 써야 할지 알 수 없어 하나의 값으로 나타낼 수 없게 됨.  


autocorrelation plot은 lag 7 지점에서 유의미한 spike를 보이고 5% 수준에서 유의한 Ljung-Box test 결과를 보여준다. 그러나 자기상관이 그리 크지 않기 때문에 lag 7에서 큰 영향을 미치지 않을 것으로 보인다.  이후 Chap 10에서 residual에 남아있는 정보를 더 가져올 수 있는 동적 회귀 모델(dynamic regression models)을 다룰 예정이다.  




### Residual plots against predictors

우리는 residual이 체계적인 패턴을 가지지 않고 무작위로 흩어져 있을거라 예상한다.  
이를 확인하는 가장 간단하고 빠른 방법은 각 예측변수에 대한 residual의 산점도(scatterplot)를 확인하는 것이다.  이러한 Scatterplot에 패턴이 나타나면 비선형 관계의 모델이 될 수 있기 때문에 모델을 수정해야 한다.  비선형 회귀에 대해서는 Chap7_7을 참고하기 바란다.  


또한 모델에 없는 예측변수에 대해서도 residual을 plotting하는 것도 필요하다.  
이들 중 하나라도 패턴을 보이는 경우, 이 예측변수를 모델에 넣어야 할 수도 있기 때문이다.



#### Example

Fig 7.9의 각 예측변수에 대해 그려진 US consumption 예측을 위한 multiple regression model의 residual은 무작위로 흩어진 것처럼 보인다. 즉 예측 변수의 변화량에 따라 residual이 선형적인 관계를 형성하지 않는다. 따라서 모델이 적절하다고 볼 수 있다.  


```{r}
us_change %>% 
    left_join(residuals(fit_consMR), by = "Quarter") %>% 
    pivot_longer(Income:Unemployment, names_to = "regressor", values_to = "x") %>% 
    ggplot(aes(x = x, y = .resid)) +
    geom_point() +
    facet_wrap(~ regressor, scales = "free_x") +
    labs(title = "Fig 7.9-Scatterplots of residuals versus each predictor",
         x = "", y = "Residuals")

```





### Residual plots against fitted values

fitted values에 대한 residual plot에도 동일하게 패턴이 없어야 한다.  패턴이 발견되면 residual에 이분산성(heteroscedasticity)이 있을 수 있다는 뜻으로 residual의 분산이 일정하지 않다는 것을 의미한다.  이러한 문제가 발견되면 log 또는 제곱근을 이용한 예측변수의 변환이 필요할 수도 있다.  




#### Example

아래 Fig 7.10에는 fitted value에 대해 plot한 residual을 보여준다.  
무작위로 분포된 것으로 볼 때 residual이 동일한 분산값을 가짐을 알 수 있다.  
(The random scatter suggests the errors are homoscedastic.)


```{r}
augment(fit_consMR) %>% 
    ggplot(aes(x = .fitted, y = .resid)) +
    geom_point() +
    labs(x = "Fitted", y = "Residuals")

```




### Outliers and influential observations

대부분의 데이터와 비교하여 극단적인 값을 가진 관측값을 **이상값(outliers)**라 한다.  
이러한 이상값은 모델의 추정계수에 큰 영향을 미친다.  

이상값의 원인 중 하나는 잘못된 데이터 입력이다.  
데이터를 확인할 때 최소값과 최대값을 보고 적절하지 않은 값은 수정하거나 제거해야 한다.  

또는 일부 관측측치가 단순하게 다를 때도 발생하는데 이런 경우에는 제거하면 안 된다.  
이상치가 실제 관측값일 가능성이 있는 경우에는 그러한 이상치가 관측된 원인과 이유를 분석하는 것이 필요하다.  



#### Example

Fig 7.11은 Income에 대해 US consumption이 회귀할 때 단일 이상값의 영향이 어떤지를 보여준다.  
왼쪽 그림에서는 Y축에서 발생한 이상치의 영향을 보여주기 위해 Consumption의 변화를 -4%로 잘못 기록되었을 때를 가정했다. 이 경우 fitted regression line(주황색)이 이상값이 없는 fitted regression line(검은색)과 차이가 크지 않음을 볼 수 있다.   


반면 오른쪽 그림에서는 X축에서 발생한 이상치의 영향을 보여주기 위해 Income의 변화를 +6%로 잘못 기록되었을 때를 가정했다. 이 경우에는 fitted regression line(주황색)이 이상값이 없는 fitted regression line(검은색)과 차이가 크게 벌어지는 것을 볼 수 있다.  


즉 이상치는 X축에서 발생할 때 그 영향력이 큰 것을 확인할 수 있다.  


![Fig 7.11](https://otexts.com/fpp3/fpp_files/figure-html/outlier-1.png)




### Spurious regression

종종 시계열 데이터는 비정상(non-stationary)이다.  
즉 시계열의 값이 일정한 평균을 중심으로 움직이거나 일정한 분산으로 변화하지 않는다.  
시계열 정상성은 Chap9에서 더 자세히 다루겠지만 이 Chapter에서는 비정상 데이터가 회귀 모델에 미칠 수 있는 영향을 다룰 필요가 있다.  

예를 들어 Fig 7.12에 표시된 두 변수를 고려해보자. 둘 다 같은 방식으로 상승추세를 보여주기 때문에 관련이 있는 것으로 보이지만 호주의 항공 여객 수속과 기니의 쌀 생산량은 아무런 관련이 없다.  

```{r}
p1 <- 
    aus_airpassengers %>% 
    ggplot(aes(Year, Passengers)) +
    geom_line() +
    labs(title = "Fig 7.12 - Air transit: Australia")

p2 <- 
    guinea_rice %>% 
    ggplot(aes(Year, Production)) +
    geom_line() +
    labs(title = "Fig 7.12 - Rice production: Guinea")
    
p3 <- 
    aus_airpassengers %>% 
    filter(Year <= 2011) %>% 
    left_join(guinea_rice, by = "Year") %>% 
    ggplot(aes(Production, Passengers)) +
    geom_point()

library(patchwork)

(p1 / p2) | p3

```



non-stationary time series를 regressing하면 가짜 회귀(spurious regressions)가 만들어질 수 있다.  
기니의 쌀 생산량에 대한 호주 항공 승객의 회귀 결과는 Fig 7.13에 나와있다.  
높은 결정계수($R^2$)와 높은  residual autocorrelation은 가짜 회귀의 징후일 수 있다.  
아래 결과에서 가짜 회귀를 확인해보고 이 부분에 대한 상세한 설명은 Chap 10를 참조하면 된다.  

가짜 회귀 사례는 합리적인 단기 예측을 제공하는 것처럼 보일 수 있으나 일반적으로 지속적으로 사용할 수 없다.   

```{r}
fit <- 
    aus_airpassengers %>% 
    filter(Year <= 2011) %>% 
    left_join(guinea_rice, by = "Year") %>% 
    model(TSLM(Passengers ~ Production))

report(fit)

```

```{r}
fit %>% gg_tsresiduals() + 
    labs(title = "Fig 7.13-Residuals from a spurious regression")

```




---



